<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Buffet ‚Ä¢ Del√≠cia Gourmet</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --primary-dark:#ea580c;
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#6b7280;
  --success:#16a34a;
  --danger:#dc2626;
  --radius:18px;
  --shadow:0 16px 40px rgba(0,0,0,.12);
}

/* Reset e base */
*{
  box-sizing:border-box;
  font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  -webkit-tap-highlight-color: transparent;
}
html, body{
  width:100%;
  height:100%;
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#fff, var(--bg));
  overscroll-behavior: none;
}
body{
  overflow:hidden;              /* tela cheia sem scroll da p√°gina */
}

/* Container principal ocupa a tela */
.app{
  max-width:1400px;             /* usa melhor telas grandes */
  margin:0 auto;
  padding:14px 14px 22px;
  min-height:100dvh;            /* altura real da viewport (mobile safe) */
  display:flex;
  flex-direction:column;
}

/* Header fixo no topo */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:12px;
}
.title{font-size:22px;font-weight:900}
.badge{
  background:#111827;color:#fff;
  padding:6px 10px;border-radius:999px;
  font-size:12px;white-space:nowrap
}

/* Cards */
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
  margin-bottom:12px;
}

/* Linha empresa */
.company-row{
  display:flex;
  gap:10px;
  align-items:center;
}
.company-row select{flex:1}

.form-grid{
  display:grid;
  grid-template-columns: 2fr 1fr 1fr;
  gap:12px;
  align-items:end;
}

.field{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.field label{
  font-size:12px;
  font-weight:700;
  color:#374151;
}

input, select, button{
  padding:14px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:16px;
  outline:none;
  height:48px;
}

.input-weight{
  font-weight:900;
  letter-spacing:.02em;
}

.input-tara{
  background:#fff7ed;
  border-color:#fed7aa;
}

.net-preview{
  font-size:12px;
  color:#374151;
  margin-top:4px;
}

.net-preview b{
  color:#16a34a;
}
input:focus, select:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(255,106,0,.15);
}

button.primary{
  background:var(--primary);
  color:#fff;border:none;
  font-weight:800;
}
button.primary:active{transform:scale(.98)}
button.ghost{
  background:#fff;border:1px dashed var(--border)
}
small{color:var(--muted)}

/* Lista com scroll interno (tela cheia) */
.list{
  display:grid;
  gap:10px;
  margin-top:8px;
  overflow:auto;
  max-height:calc(100dvh - 360px); /* ajusta conforme header + cards */
  padding-right:4px;
}
.item{
  display:grid;
  grid-template-columns:1fr auto;
  gap:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#fff;
}
.item .name{font-weight:800}
.meta{font-size:13px;color:var(--muted)}
.tag{
  padding:6px 10px;border-radius:999px;
  font-size:12px;font-weight:800
}
.MONTAGEM{background:#dcfce7;color:#166534}
.REPOSICAO{background:#e0f2fe;color:#075985}
.RETIRADA{background:#fee2e2;color:#991b1b}
.DEVOLUCAO{background:#fef3c7;color:#92400e}
.icon-btn{
  border:1px solid var(--border);
  background:#fff;border-radius:10px;padding:8px
}
.icon-btn.danger{border-color:#fecaca;color:#b91c1c}

/* Modal fullscreen no mobile */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index:999;
}
.modal{
  width:100%;
  max-width:560px;
  background:#fff;
  border-radius:22px 22px 0 0;
  padding:16px;
  box-shadow:0 -20px 40px rgba(0,0,0,.25);
  animation:slideUp .18s ease-out;
}
@keyframes slideUp{
  from{transform:translateY(24px);opacity:.6}
  to{transform:none;opacity:1}
}
.modal h3{margin:0 0 8px 0}
.modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}

/* Desktop: modal centralizado */
@media (min-width: 900px){
  .modal-backdrop{align-items:center}
  .modal{border-radius:22px}
}

/* Mobile: tudo em coluna, sem zoom */
@media (max-width: 720px){
  .form-grid{grid-template-columns:1fr}
  .title{font-size:20px}
  .badge{font-size:11px}
  .list{
    max-height:calc(100dvh - 400px); /* mais espa√ßo pro teclado */
  }
}

/* Evita rolagem lateral */
body, .app{
  overflow-x:hidden;
}

@keyframes spin{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="title">üçΩÔ∏è Buffet ‚Ä¢ Del√≠cia Gourmet</div>
    <span class="badge">Hoje: <b id="dataHoje"></b></span>
  </div>

  <!-- Sele√ß√£o de empresa -->
  <div class="card company-row">
    <b>Empresa:</b>
<select id="empresaSelect">
  <option value="DEL√çCIA GOURMET">Del√≠cia Gourmet</option>
</select>
  </div>

  <div class="card">
<div class="form-grid">
  <div class="field">
    <label>Prato</label>
    <input id="produto" placeholder="Digite o prato (busca + cadastra)" list="produtosList">
  </div>

  <div class="field">
    <label>Peso bruto (kg)</label>
    <input id="quantidade" class="input-weight" inputmode="decimal" placeholder="0,000">
  </div>

  <div class="field">
    <label>Tara (kg)</label>
    <input id="tara" class="input-tara" inputmode="decimal" placeholder="0,000">
    <div class="net-preview" id="pesoLiquidoPreview">L√≠quido: <b>0,000 kg</b></div>
  </div>

  <div class="field">
    <label>Unidade</label>
    <select id="unidade">
      <option value="KG">KG</option>
      <option value="UN">UN</option>
    </select>
  </div>

  <div class="field">
    <label>Tipo</label>
    <select id="tipo">
      <option value="MONTAGEM">Montagem</option>
      <option value="REPOSICAO">Reposi√ß√£o</option>
      <option value="RETIRADA">Retirada</option>
      <option value="DEVOLUCAO">Devolu√ß√£o</option>
    </select>
  </div>
</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
      <button class="primary" id="btnSalvar"><i class="ri-save-3-line"></i> Salvar</button>
      <button class="ghost" id="btnLimpar"><i class="ri-eraser-line"></i> Limpar</button>
    </div>
    <small>Data √© travada no dia atual e hora √© autom√°tica.</small>
  </div>

  <div class="card">
    <b>üìã Lan√ßamentos de Hoje</b>
    <div class="list" id="lista"></div>
  </div>

</div>

<datalist id="produtosList"></datalist>

<!-- MODAL DE EDI√á√ÉO -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <h3>‚úèÔ∏è Editar lan√ßamento</h3>
    <div class="grid">
      <input id="editQuantidade" type="number" step="0.001" placeholder="Quantidade">
      <select id="editUnidade">
        <option value="KG">KG</option>
        <option value="UN">UN</option>
      </select>
      <select id="editTipo" style="grid-column:1/-1">
        <option value="MONTAGEM">Montagem</option>
        <option value="REPOSICAO">Reposi√ß√£o</option>
        <option value="RETIRADA">Retirada</option>
        <option value="DEVOLUCAO">Devolu√ß√£o</option>
      </select>
    </div>
    <div class="actions">
      <button class="ghost" onclick="fecharModal()">Cancelar</button>
      <button class="primary" onclick="confirmarEdicao()">Salvar altera√ß√µes</button>
    </div>
  </div>
</div>

<script>
  const sb = window.supabase.createClient(
    "https://dxkszikemntfusfyrzos.supabase.co",
    "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
  );

  const produtoInput = document.getElementById("produto");
  const quantidadeInput = document.getElementById("quantidade");
  const taraInput = document.getElementById("tara");
  const unidadeSelect = document.getElementById("unidade");
  const tipoSelect = document.getElementById("tipo");
  const lista = document.getElementById("lista");
  const btnSalvar = document.getElementById("btnSalvar");
  const btnLimpar = document.getElementById("btnLimpar");
  const empresaSelect = document.getElementById("empresaSelect");
// ================== TARA PADR√ÉO POR PRODUTO ==================
produtoInput.addEventListener("change", aplicarTaraPadraoPorProduto);
produtoInput.addEventListener("blur", aplicarTaraPadraoPorProduto);

async function aplicarTaraPadraoPorProduto(){
  const empresa = empresaSelect.value;
  const nome = produtoInput.value.trim().toUpperCase();
  if(!nome) return;

  const { data:prod } = await sb
    .from("buffet_produtos")
    .select("tara_padrao")
    .eq("empresa", empresa)
    .eq("nome", nome)
    .maybeSingle();

  if(prod?.tara_padrao != null){
    taraInput.value = formatPeso(prod.tara_padrao);
    atualizarLiquidoPreview();
  }
}
  const hoje = new Date();
  const dataISO = hoje.toISOString().slice(0,10);
  const dataBR = hoje.toLocaleDateString("pt-BR");
  document.getElementById("dataHoje").innerText = dataBR;

  let editId = null;

  async function carregarProdutos(){
    const empresa = empresaSelect.value;
    const { data } = await sb
      .from("buffet_produtos")
      .select("nome")
      .eq("empresa", empresa)
      .order("nome");

    const list = document.getElementById("produtosList");
    list.innerHTML = "";
    data?.forEach(p=>{
      const o = document.createElement("option");
      o.value = p.nome;
      list.appendChild(o);
    });
  }

  async function carregarLancamentos(){
    const empresa = empresaSelect.value;
    const { data } = await sb
      .from("buffet_lancamentos")
      .select("*")
      .eq("empresa", empresa)
      .eq("data", dataISO)
      .order("created_at", { ascending:false });

    lista.innerHTML = "";
    data?.forEach(l=>{
      lista.innerHTML += `
        <div class="item">
          <div>
            <div class="name">${l.produto_nome}</div>
            <div class="meta">${l.quantidade} ${l.unidade} ‚Ä¢ ${l.hora}</div>
            <span class="tag ${l.tipo}">${l.tipo}</span>
          </div>
          <div style="display:flex;gap:8px">
            <button class="icon-btn" onclick="abrirModal('${l.id}', ${l.quantidade}, '${l.unidade}', '${l.tipo}')">
              <i class="ri-edit-2-line"></i>
            </button>
            <button class="icon-btn danger" onclick="excluir('${l.id}')">
              <i class="ri-delete-bin-6-line"></i>
            </button>
          </div>
        </div>
      `;
    });
  }

async function salvar(){
  try{
    showSaving(); // üëà abre overlay

    const empresa = empresaSelect.value;
    const produtoNome = produtoInput.value.trim().toUpperCase();
    const pesoBruto = parsePeso(quantidadeInput.value);
    const tara = parsePeso(taraInput.value || 0);
    const unidade = unidadeSelect.value;
    const tipo = tipoSelect.value;

    if(!produtoNome || pesoBruto <= 0){
      alert("Preencha tudo");
      hideSaving();
      return;
    }
    if(tara > pesoBruto){
      alert("Tara n√£o pode ser maior que o peso bruto");
      hideSaving();
      return;
    }

    const quantidadeLiquida = Number((pesoBruto - tara).toFixed(3));

    let { data:prod } = await sb
      .from("buffet_produtos")
      .select("*")
      .eq("empresa", empresa)
      .eq("nome", produtoNome)
      .maybeSingle();

    if(!prod){
      const { data:nova } = await sb
        .from("buffet_produtos")
        .insert({ empresa, nome: produtoNome, unidade_padrao: unidade, tara_padrao: tara })
        .select().single();
      prod = nova;
      carregarProdutos();
    }

    const hora = new Date().toTimeString().slice(0,8);

    await sb.from("buffet_lancamentos").insert({
      empresa,
      produto_id: prod.id,
      produto_nome: produtoNome,
      tipo,
      quantidade: quantidadeLiquida,
      tara,
      unidade,
      data: dataISO,
      hora
    });

    const { data:ultimas } = await sb
      .from("buffet_lancamentos")
      .select("tara")
      .eq("produto_id", prod.id)
      .not("tara", "is", null)
      .order("created_at", { ascending:false })
      .limit(3);

    if(ultimas?.length){
      const maisUsada = ultimas
        .map(x => Number(x.tara || 0))
        .sort((a,b) =>
          ultimas.filter(u=>u.tara===a).length -
          ultimas.filter(u=>u.tara===b).length
        )
        .pop();

      await sb.from("buffet_produtos")
        .update({ tara_padrao: maisUsada })
        .eq("id", prod.id);
    }

    limpar();
    carregarLancamentos();

  } catch(err){
    console.error(err);
    alert("Erro ao salvar. Verifique a internet.");
  } finally {
    hideSaving(); // üëà fecha overlay sempre
  }
}


function showSaving(){
  document.getElementById("savingOverlay").style.display = "flex";
}
function hideSaving(){
  document.getElementById("savingOverlay").style.display = "none";
}
  function abrirModal(id, qtd, un, tipo){
    editId = id;
    document.getElementById("editQuantidade").value = qtd;
    document.getElementById("editUnidade").value = un;
    document.getElementById("editTipo").value = tipo;
    document.getElementById("modalBackdrop").style.display = "flex";
  }
  function fecharModal(){
    document.getElementById("modalBackdrop").style.display = "none";
    editId = null;
  }
  async function confirmarEdicao(){
    const qtd = parseFloat(document.getElementById("editQuantidade").value);
    const un = document.getElementById("editUnidade").value;
    const tipo = document.getElementById("editTipo").value;
    if(!qtd){ alert("Quantidade inv√°lida"); return; }

    await sb.from("buffet_lancamentos")
      .update({ quantidade:qtd, unidade:un, tipo })
      .eq("id", editId);

    fecharModal(); carregarLancamentos();
  }

  async function excluir(id){
    if(!confirm("Excluir esse lan√ßamento?")) return;
    await sb.from("buffet_lancamentos").delete().eq("id", id);
    carregarLancamentos();
  }

function limpar(){
  produtoInput.value = "";
  quantidadeInput.value = "";
taraInput.value = "";
  unidadeSelect.value = "KG";
  tipoSelect.value = "MONTAGEM";
}

  btnSalvar.onclick = salvar;
  btnLimpar.onclick = limpar;
empresaSelect.onchange = () => {
  carregarProdutos();
  carregarLancamentos();
  taraInput.value = "";  // limpa a tara ao trocar empresa
  document.getElementById("pesoLiquidoPreview").innerHTML =
    `L√≠quido: <b>0,000 kg</b>`;
};
  carregarProdutos();
  carregarLancamentos();


function parsePeso(v){
  if(!v) return 0;
  return Number(String(v).replace(",", ".").replace(/[^\d.]/g, ""));
}

function formatPeso(v){
  return (Number(v || 0).toFixed(3)).replace(".", ",");
}

function atualizarLiquidoPreview(){
  const bruto = parsePeso(quantidadeInput.value);
const tara = parsePeso(taraInput.value);
  const liquido = Math.max(0, bruto - tara);
  document.getElementById("pesoLiquidoPreview").innerHTML =
    `L√≠quido: <b>${formatPeso(liquido)} kg</b>`;
}

function aplicarMascaraKg(input){
  let v = input.value || "";

  // mant√©m s√≥ n√∫meros
  v = v.replace(/\D/g, "");

  // garante 3 casas decimais
  if(v.length === 0) v = "000";
  if(v.length === 1) v = "00" + v;
  if(v.length === 2) v = "0" + v;

  const inteiro = v.slice(0, -3);
  const dec = v.slice(-3);

  input.value = (Number(inteiro) || 0) + "," + dec;
}

quantidadeInput.addEventListener("input", () => {
  aplicarMascaraKg(quantidadeInput);
  atualizarLiquidoPreview();
});

taraInput.addEventListener("input", () => {
  aplicarMascaraKg(taraInput);
  atualizarLiquidoPreview();
});
</script>
<!-- OVERLAY DE SALVAMENTO -->
<div id="savingOverlay" style="
  position:fixed; inset:0; z-index:9999;
  background:rgba(15,23,42,.55);
  display:none; align-items:center; justify-content:center;
  backdrop-filter: blur(2px);
">
  <div style="
    background:#fff; padding:22px 26px; border-radius:16px;
    display:flex; align-items:center; gap:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.25)
  ">
    <i class="ri-loader-4-line" style="
      font-size:26px; color:#ff6a00; animation:spin 1s linear infinite
    "></i>
    <b>Salvando...</b>
  </div>
</div>
</body>
</html>
