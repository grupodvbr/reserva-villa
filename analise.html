<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Buffet ‚Ä¢ Anal√≠tico por Item</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f6f7fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#6b7280;
  --radius:16px;
  --shadow:0 10px 28px rgba(0,0,0,.10);
}
*{box-sizing:border-box;font-family:Inter}
html,body{margin:0;background:var(--bg)}
.app{max-width:100%;margin:auto;padding:8px 8px 72px}
.header{padding:8px 0 6px;margin-bottom:6px}
.title{font-size:18px;font-weight:900}
.sub{font-size:11px;color:var(--muted)}

.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px;margin-bottom:8px}

/* Filtros */
.filters{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px;
}
.filters select,.filters input,.filters button{
  width:100%;
  padding:9px 10px;border-radius:10px;border:1px solid var(--border);font-size:13px
}
.filters button{
  grid-column:1/-1;
  background:var(--primary);color:#fff;border:none;font-weight:800
}
@media(min-width:900px){
  .app{max-width:1100px}
  .filters{grid-template-columns:1fr 1fr auto}
  .filters button{grid-column:auto}
}

/* Lista */
.list{display:grid;gap:6px}
.item{
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px;
  display:grid;gap:6px;
  cursor:pointer;
}
.item:hover{background:#fafafa}
.item .name{font-weight:800;font-size:13px}
.row{display:grid;grid-template-columns:1fr auto;gap:6px;font-size:12px}
.badge{padding:3px 7px;border-radius:999px;font-size:10px;font-weight:800}
.mont{background:#dcfce7;color:#166534}
.rep{background:#e0f2fe;color:#075985}
.ret{background:#fee2e2;color:#991b1b}
.dev{background:#fef3c7;color:#92400e}
.tot{background:#f1f5f9;color:#0f172a}

/* Modal */
.backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;align-items:flex-end;justify-content:center;z-index:999;
}
.modal{
  width:100%;max-width:520px;background:#fff;border-radius:16px 16px 0 0;
  padding:12px;box-shadow:0 -16px 40px rgba(0,0,0,.25);
}
.modal h3{margin:4px 0 8px 0}
.modal .log{display:grid;gap:6px;max-height:60vh;overflow:auto}
.log-item{
  border:1px solid var(--border);border-radius:10px;padding:8px;font-size:12px;
  display:grid;grid-template-columns:1fr auto;gap:6px
}
@media(min-width:900px){
  .backdrop{align-items:center}
  .modal{border-radius:16px}
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="title">üìä Anal√≠tico por Item</div>
    <div class="sub">Empresa ‚Ä¢ Per√≠odo ‚Ä¢ Movimenta√ß√µes</div>
  </div>

  <div class="card">
    <div class="filters">
      <select id="empresaSelect">
        <option value="VILLA GOURMET">Villa Gourmet</option>
        <option value="CHURRASCADA">Churrascada</option>
        <option value="MERCATTO DEL√çCIA">Mercatto Del√≠cia</option>
        <option value="DEL√çCIA GOURMET">Del√≠cia Gourmet</option>
      </select>
      <!-- Per√≠odo em um calend√°rio (input range nativo funciona no mobile moderno) -->
      <input type="text" id="periodo" placeholder="Ex: 01/02/2026 - 10/02/2026" readonly>
      <button id="btnFiltrar">Atualizar</button>
    </div>
  </div>

  <div class="card">
    <b style="font-size:13px">Itens do per√≠odo</b>
    <div class="list" id="list"></div>
  </div>

</div>

<!-- MODAL -->
<div class="backdrop" id="backdrop" onclick="fecharModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalTitle">Movimenta√ß√µes</h3>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
const sb = window.supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const empresaSelect = document.getElementById("empresaSelect");
const periodoInput = document.getElementById("periodo");
const btnFiltrar = document.getElementById("btnFiltrar");
const list = document.getElementById("list");
const backdrop = document.getElementById("backdrop");
const logEl = document.getElementById("log");
const modalTitle = document.getElementById("modalTitle");

// Range simples (7 dias por padr√£o)
const hoje = new Date();
const fimISO = hoje.toISOString().slice(0,10);
const iniISO = new Date(hoje.getTime()-6*24*60*60*1000).toISOString().slice(0,10);
periodoInput.value = `${new Date(iniISO).toLocaleDateString("pt-BR")} - ${new Date(fimISO).toLocaleDateString("pt-BR")}`;

function parsePeriodo(){
  const [iniBR,fimBR] = periodoInput.value.split(" - ");
  const [di,mi,yi] = iniBR.split("/"); 
  const [df,mf,yf] = fimBR.split("/");
  return {
    ini: `${yi}-${mi}-${di}`,
    fim: `${yf}-${mf}-${df}`
  };
}

async function carregar(){
  const empresa = empresaSelect.value;
  const { ini, fim } = parsePeriodo();

  let q = sb.from("buffet_lancamentos")
    .select("*")
    .eq("empresa", empresa)
    .gte("data", ini)
    .lte("data", fim);

  const { data } = await q.order("data",{ascending:true});

  const porItem = {};
  data?.forEach(r=>{
    porItem[r.produto_nome] ||= {MONTAGEM:0,REPOSICAO:0,RETIRADA:0,DEVOLUCAO:0, UNIDADE:r.unidade};
    porItem[r.produto_nome][r.tipo] += Number(r.quantidade||0);
  });

  list.innerHTML = Object.entries(porItem).map(([nome,v])=>{
    const total = v.MONTAGEM + v.REPOSICAO;
    return `
      <div class="item" onclick="abrirModal('${nome.replace(/'/g,"\\'")}')">
        <div class="name">${nome}</div>
        <div class="row"><span class="badge mont">Mont</span><b>${v.MONTAGEM.toFixed(2)} ${v.UNIDADE}</b></div>
        <div class="row"><span class="badge rep">Rep</span><b>${v.REPOSICAO.toFixed(2)} ${v.UNIDADE}</b></div>
        <div class="row"><span class="badge tot">Total</span><b>${total.toFixed(2)} ${v.UNIDADE}</b></div>
        <div class="row"><span class="badge ret">Ret</span><b>${v.RETIRADA.toFixed(2)} ${v.UNIDADE}</b></div>
        <div class="row"><span class="badge dev">Dev</span><b>${v.DEVOLUCAO.toFixed(2)} ${v.UNIDADE}</b></div>
      </div>
    `;
  }).join("");
}

async function abrirModal(produto){
  const empresa = empresaSelect.value;
  const { ini, fim } = parsePeriodo();

  modalTitle.textContent = `Movimenta√ß√µes ‚Ä¢ ${produto}`;
  backdrop.style.display = "flex";
  logEl.innerHTML = "Carregando...";

  const { data } = await sb.from("buffet_lancamentos")
    .select("*")
    .eq("empresa", empresa)
    .eq("produto_nome", produto)
    .gte("data", ini)
    .lte("data", fim)
    .order("created_at",{ascending:false});

  logEl.innerHTML = data?.map(r=>`
    <div class="log-item">
      <div>
        <b>${r.tipo}</b><br>
        <small>${new Date(r.data).toLocaleDateString("pt-BR")} ‚Ä¢ ${r.hora}</small>
      </div>
      <b>${Number(r.quantidade).toFixed(2)} ${r.unidade}</b>
    </div>
  `).join("") || "<small>Sem movimenta√ß√µes.</small>";
}

function fecharModal(){ backdrop.style.display="none"; }

// Atualiza√ß√µes
btnFiltrar.onclick = carregar;
empresaSelect.onchange = carregar;

// Primeira carga
carregar();
</script>
</body>
</html>
