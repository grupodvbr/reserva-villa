<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Buffet ‚Ä¢ Anal√≠tico Operacional</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<style>
:root{
  --primary:#ff6a00;
  --bg:#f6f7fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#6b7280;
  --radius:18px;
  --shadow:0 12px 34px rgba(0,0,0,.10);
}
*{box-sizing:border-box;font-family:Inter}
html,body{margin:0;background:var(--bg)}
.app{max-width:1100px;margin:auto;padding:10px 10px 72px}

.header{
  position:sticky;top:0;z-index:20;
  background:linear-gradient(180deg,#fff, #fff0);
  backdrop-filter: blur(6px);
  padding:10px 0 8px;
  margin-bottom:8px;
}
.title{font-size:20px;font-weight:900}
.sub{font-size:12px;color:var(--muted)}

.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:12px;
  margin-bottom:10px;
}

.filters{
  display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;
}
.filters input,.filters select,.filters button{
  padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px
}
.filters button{background:var(--primary);color:#fff;border:none;font-weight:800}

.chart-wrap{height:180px}

/* Remover layout em cards (mobile) */
.list{display:none}

/* Tabela sempre vis√≠vel (desktop + mobile) */
.table{display:block}

/* Wrapper SEM rolagem lateral */
.table-wrap{
  width:100%;
  overflow-x:hidden;
  border-radius:12px;
}

/* Tabela fluida, sem largura m√≠nima */
table{
  width:100%;
  min-width:0;            /* remove largura m√≠nima */
  table-layout:fixed;    /* for√ßa colunas a caberem */
  border-collapse:collapse;
}

/* Colunas compactadas */
th,td{
  padding:6px 6px;       /* menos padding no mobile */
  border-bottom:1px solid var(--border);
  text-align:left;
  font-size:12px;       /* fonte menor no celular */
  white-space:normal;  /* permite quebrar texto */
  word-break:break-word;
}

/* Ajustes finos s√≥ no mobile */
@media(max-width: 899px){
  th:nth-child(1), td:nth-child(1){ width:34% } /* Prato */
  th:nth-child(2), td:nth-child(2){ width:11% } /* Montado */
  th:nth-child(3), td:nth-child(3){ width:11% } /* Reposto */
  th:nth-child(4), td:nth-child(4){ width:12% } /* Total */
  th:nth-child(5), td:nth-child(5){ width:11% } /* Retirado */
  th:nth-child(6), td:nth-child(6){ width:11% } /* Desperd√≠cio */
}

th{
  background:#fafafa;
  position:sticky;
  top:0;
  z-index:1;
}

/* Ajustes finos no mobile */
@media(max-width: 899px){
  .filters{
    grid-template-columns:1fr 1fr; /* 2 por linha no celular */
  }
  .filters button{
    grid-column:1 / -1; /* bot√£o ocupa a linha inteira */
  }
  .title{font-size:18px}
  .sub{font-size:12px}
  .chart-wrap{height:200px}
}

/* ===== MODAL ===== */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
  padding:16px;
}
.modal{
  width:100%;
  max-width:420px;
  background:#fff;
  border-radius:16px;
  box-shadow:0 20px 50px rgba(0,0,0,.25);
  padding:16px;
}
.modal h3{
  margin:0 0 10px;
  font-size:16px;
  font-weight:900;
}
.actions{
  display:flex;
  gap:10px;
  margin-top:12px;
  justify-content:flex-end;
}
.actions button{
  padding:10px 14px;
  border-radius:10px;
  border:none;
  font-weight:800;
  cursor:pointer;
}
.actions .ghost{
  background:#f1f5f9;
  color:#0f172a;
}

/* üîí Garante que nada estoure a largura da tela no celular */
html, body {
  max-width: 100%;
  overflow-x: hidden;
}

/* üß© Tabela sempre se adapta ao tamanho da tela */
.table-wrap, table {
  max-width: 100%;
}

/* üì± Inputs e selects 100% no mobile */
@media(max-width: 899px){
  .filters input,
  .filters select,
  .filters button{
    width: 100%;
  }

  /* üîΩ Esconde o bot√£o Atualizar no mobile (j√° √© autom√°tico) */
  #btnFiltrar{
    display:none;
  }
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="title">An√°lise de Buffet</div>
    <div class="sub">Montagem ‚Ä¢ Reposi√ß√£o ‚Ä¢ Retirada ‚Ä¢ Desperd√≠cio</div>
  </div>

  <div class="card">
<div class="filters">
  <select id="empresaSelect">
    <option value="VILLA GOURMET">Villa Gourmet</option>
    <option value="CHURRASCADA">Churrascada</option>
    <option value="MERCATTO DEL√çCIA">Mercatto Del√≠cia</option>
    <option value="DEL√çCIA GOURMET">Del√≠cia Gourmet</option>
  </select>

  <input type="text" id="rangeDatas" placeholder="Selecione o per√≠odo">

  <!-- üîé NOVO -->
  <input
    type="text"
    id="searchPrato"
    placeholder="Buscar prato..."
  >

</div>
  </div>

  <div class="card">
    <b>Total produzido por dia (Montagem + Reposi√ß√£o)</b>
    <div class="chart-wrap">
      <canvas id="chart"></canvas>
    </div>
  </div>
<div class="card">
  <b>Resumo do per√≠odo selecionado</b>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px">
    <div class="card" style="padding:10px">
      <small>Total Produzido</small>
      <h3 id="totalProduzido">0</h3>
    </div>
    <div class="card" style="padding:10px">
      <small>Total Retirado</small>
      <h3 id="totalRetirado">0</h3>
    </div>
    <div class="card" style="padding:10px">
      <small>Total Desperd√≠cio</small>
      <h3 id="totalDesperdicio">0</h3>
    </div>
    <div class="card" style="padding:10px;background:#ecfeff">
      <small>Total Vendido (Reposto - Retirado - Desperd√≠cio)</small>
      <h3 id="totalVendido">0</h3>
    </div>
  </div>
</div>
  <div class="card">
    <b>Resumo por prato (Empresa selecionada)</b>

    <!-- MOBILE -->
    <div class="list" id="list"></div>

<!-- TABELA (desktop + mobile) -->
<div class="table">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Prato</th>
          <th>Montado</th>
          <th>Reposto</th>
          <th>Total</th>
          <th>Retirado</th>
          <th>Desperd√≠cio</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

</div>

<script>
const sb = window.supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const empresaSelect = document.getElementById("empresaSelect");

const btnFiltrar = document.getElementById("btnFiltrar");
const searchPrato = document.getElementById("searchPrato");
const hoje = new Date();
const seteDiasAtras = new Date(hoje.getTime() - 6*24*60*60*1000);

let rangeSelecionado = [
  seteDiasAtras.toISOString().slice(0,10),
  hoje.toISOString().slice(0,10)
];

flatpickr("#rangeDatas", {
  mode: "range",
  dateFormat: "Y-m-d",     // formato interno (para o Supabase)
  altInput: true,         // cria um input visual alternativo
  altFormat: "d/m/Y",     // formato exibido (dia/m√™s/ano)
  locale: "pt",
  defaultDate: rangeSelecionado,
  onChange: (datas) => {
    if (datas.length === 2) {
      rangeSelecionado = datas.map(d => d.toISOString().slice(0,10));
    }
  }
});
let chart;

function formatBR(iso){
  const [y,m,d]=iso.split("-");
  return `${d}/${m}/${y}`;
}

async function carregar(){
  const empresa = empresaSelect.value;

  let q = sb.from("buffet_lancamentos")
    .select("*")
    .eq("empresa", empresa);

if(rangeSelecionado.length === 2){
  q = q.gte("data", rangeSelecionado[0]);
  q = q.lte("data", rangeSelecionado[1]);
}

const { data, error } = await q.order("data",{ascending:true});
if(error){
  console.error("Erro ao carregar buffet_lancamentos:", error);
}

const porPrato = {};
const porDia = {};
let totalMontado = 0;
let totalReposto = 0;
let totalRetirado = 0;
let totalDesperdicio = 0;
  
(data || []).forEach(r=>{
  porPrato[r.produto_nome] ||= {MONTAGEM:0,REPOSICAO:0,RETIRADA:0,DEVOLUCAO:0, UNIDADE:r.unidade};
  porPrato[r.produto_nome][r.tipo] += Number(r.quantidade||0);

  const q = Number(r.quantidade || 0);

  if(r.tipo === "MONTAGEM") totalMontado += q;
  if(r.tipo === "REPOSICAO") totalReposto += q;
  if(r.tipo === "RETIRADA") totalRetirado += q;
  if(r.tipo === "DEVOLUCAO") totalDesperdicio += q;

  if(r.tipo==='MONTAGEM' || r.tipo==='REPOSICAO'){
    porDia[r.data] = (porDia[r.data]||0) + q;
  }
});
const termo = (searchPrato.value || "").toLowerCase();

const pratosFiltrados = Object.entries(porPrato)
  .filter(([nome]) => (nome || "").toLowerCase().includes(termo))
  .sort((a,b)=> (a[0] || "").localeCompare(b[0] || "", 'pt-BR'));

list.innerHTML = pratosFiltrados.map(([nome,v])=>{
  const total = v.MONTAGEM + v.REPOSICAO;
  return `
    <div class="item">
      <div class="name">${nome}</div>
      <div class="row"><span class="badge mont">Montado</span><b>${v.MONTAGEM.toFixed(2)} ${v.UNIDADE}</b></div>
      <div class="row"><span class="badge rep">Reposto</span><b>${v.REPOSICAO.toFixed(2)} ${v.UNIDADE}</b></div>
      <div class="row"><span class="badge tot">Total</span><b>${total.toFixed(2)} ${v.UNIDADE}</b></div>
      <div class="row"><span class="badge ret">Retirado</span><b>${v.RETIRADA.toFixed(2)} ${v.UNIDADE}</b></div>
      <div class="row"><span class="badge dev">desperd√≠cio</span><b>${v.DEVOLUCAO.toFixed(2)} ${v.UNIDADE}</b></div>
    </div>
  `;
}).join("");

tbody.innerHTML = pratosFiltrados.map(([nome,v])=>{
  const total = v.MONTAGEM + v.REPOSICAO;
  return `
    <tr>
      <td>
        ${
          nome === "CONSUMO AUTORIZADO"
            ? `<b style="cursor:pointer;color:#ff6a00;text-decoration:underline" onclick="abrirResumoConsumo('${nome}')">${nome}</b>`
            : `<b>${nome}</b>`
        }
      </td>
      <td>${v.MONTAGEM.toFixed(2)} ${v.UNIDADE}</td>
      <td>${v.REPOSICAO.toFixed(2)} ${v.UNIDADE}</td>
      <td><b>${total.toFixed(2)} ${v.UNIDADE}</b></td>
      <td>${v.RETIRADA.toFixed(2)} ${v.UNIDADE}</td>
      <td>${v.DEVOLUCAO.toFixed(2)} ${v.UNIDADE}</td>
    </tr>
  `;
}).join("");

  const dias = Object.keys(porDia).sort();
  const valores = dias.map(d=>porDia[d]);

  if(chart) chart.destroy();
  // ===== RESUMO DO PER√çODO =====
const totalProduzido = totalMontado + totalReposto;
const totalVendido = totalReposto - totalRetirado - totalDesperdicio;

document.getElementById("totalProduzido").innerText =
  totalProduzido.toFixed(2);

document.getElementById("totalRetirado").innerText =
  totalRetirado.toFixed(2);

document.getElementById("totalDesperdicio").innerText =
  totalDesperdicio.toFixed(2);

document.getElementById("totalVendido").innerText =
  totalVendido.toFixed(2);
chart = new Chart(document.getElementById("chart"), {
  type: 'line',
  data: {
    labels: dias.map(formatBR),
    datasets: [{
      label: 'Total produzido',
      data: valores,
      tension: .35,

      // üî• tamanho VISUAL da bolinha
      pointRadius: 4,
      pointHoverRadius: 6,

      // üî• √°rea de TOQUE (invis√≠vel) ‚Äì isso que facilita clicar no celular
      pointHitRadius: 20
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },

    // melhora a detec√ß√£o de toque no mobile
    interaction: {
      mode: 'nearest',
      intersect: false
    }
  }
});
}



// üîÅ Atualiza automaticamente quando mudar empresa
empresaSelect.onchange = () => {
  searchPrato.value = "";
  carregar();
};

// üîé Atualiza enquanto digita o prato
searchPrato.oninput = carregar;

// üìÖ Atualiza quando mudar o per√≠odo (flatpickr)
flatpickr("#rangeDatas", {
  mode: "range",
  dateFormat: "Y-m-d",
  altInput: true,
  altFormat: "d/m/Y",
  locale: "pt",
  defaultDate: rangeSelecionado,
  onChange: (datas) => {
    if (datas.length === 2) {
      rangeSelecionado = datas.map(d => d.toISOString().slice(0,10));
      carregar(); // ‚úÖ atualiza automaticamente ao mudar data
    }
  }
});

carregar();
let modalAberto = false;

async function abrirResumoConsumo(nome){
  if(nome !== "CONSUMO AUTORIZADO" || modalAberto) return;
  modalAberto = true;

  const empresa = empresaSelect.value;

  let q = sb.from("buffet_lancamentos")
    .select("consumo_para_nome, quantidade")
    .eq("empresa", empresa)
    .eq("consumo_autorizado", true);

  if(rangeSelecionado.length === 2){
    q = q.gte("data", rangeSelecionado[0]);
    q = q.lte("data", rangeSelecionado[1]);
  }

  const { data } = await q;

  const porPessoa = {};
  data?.forEach(r=>{
    const nome = r.consumo_para_nome || "SEM NOME";
    porPessoa[nome] = (porPessoa[nome] || 0) + Number(r.quantidade || 0);
  });

  const html = Object.entries(porPessoa)
    .sort((a,b)=>b[1]-a[1])
    .map(([nome,kg])=>`
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee">
        <b>${nome}</b>
        <span>${kg.toFixed(3)} KG</span>
      </div>
    `).join("");

  document.getElementById("listaResumoConsumo").innerHTML =
    html || "<small>Nenhum consumo no per√≠odo.</small>";

document.getElementById("modalResumoConsumo").style.display = "flex";
document.body.style.overflow = "hidden";}

function fecharResumoConsumo(){
  document.getElementById("modalResumoConsumo").style.display = "none";
  document.body.style.overflow = "auto";
  modalAberto = false;
}
</script>
<!-- MODAL RESUMO CONSUMO AUTORIZADO -->
<div class="modal-backdrop" id="modalResumoConsumo" onclick="if(event.target===this) fecharResumoConsumo()">  <div class="modal">
    <h3>üìä Consumo autorizado (KG)</h3>
    <div id="listaResumoConsumo" style="max-height:60vh;overflow:auto"></div>
    <div class="actions">
      <button class="ghost" onclick="fecharResumoConsumo()">Fechar</button>
    </div>
  </div>
</div>
</body>
</html>
