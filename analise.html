<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Buffet ‚Ä¢ Relat√≥rio Anal√≠tico Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#6b7280;
  --radius:20px;
  --shadow:0 18px 48px rgba(0,0,0,.12);
}
*{box-sizing:border-box;font-family:Inter}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#fff, var(--bg))}
.app{max-width:1500px;margin:0 auto;padding:14px;min-height:100dvh;display:flex;flex-direction:column}
.header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:24px;font-weight:900}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
.filters{display:grid;grid-template-columns:1fr 1fr auto;gap:10px}
input,button{padding:12px 14px;border-radius:12px;border:1px solid var(--border);font-size:16px}
button.primary{background:var(--primary);color:#fff;border:none;font-weight:800}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{border:1px solid var(--border);border-radius:16px;padding:14px}
.kpi b{font-size:18px}
.kpi small{color:var(--muted)}
.rank{display:grid;gap:8px}
.rank-item{display:flex;justify-content:space-between;gap:10px;border:1px solid var(--border);border-radius:12px;padding:10px}
.table{overflow:auto}
.table table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
@media (max-width: 900px){
  .filters{grid-template-columns:1fr}
  .grid{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr 1fr}
}
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <div class="title">üìä Buffet ‚Ä¢ Relat√≥rio Anal√≠tico Premium</div>
    <a href="./index.html" style="text-decoration:none">‚¨ÖÔ∏è Voltar ao Operacional</a>
  </div>

  <div class="card">
    <div class="filters">
      <input type="date" id="dtInicio">
      <input type="date" id="dtFim">
      <button class="primary" id="btnFiltrar"><i class="ri-filter-3-line"></i> Atualizar</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <b>üìà Evolu√ß√£o di√°ria por empresa</b>
      <canvas id="chartLinhas" height="160"></canvas>
    </div>
    <div class="card">
      <b>üìä Distribui√ß√£o por tipo (empresas)</b>
      <canvas id="chartTipos" height="160"></canvas>
    </div>
  </div>

  <div class="card">
    <b>üìå KPIs por empresa (per√≠odo)</b>
    <div id="kpisEmpresas" class="kpis"></div>
  </div>

  <div class="grid">
    <div class="card">
      <b>üèÜ Top pratos do per√≠odo</b>
      <div id="ranking" class="rank"></div>
    </div>
    <div class="card table">
      <b>üßæ Registros do per√≠odo</b>
      <table>
        <thead>
          <tr>
            <th>Data</th><th>Empresa</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Hora</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const sb = window.supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const dtInicio = document.getElementById("dtInicio");
const dtFim = document.getElementById("dtFim");
const btnFiltrar = document.getElementById("btnFiltrar");
let chartLinhas, chartTipos;

function formatBR(iso){ const [y,m,d]=iso.split("-"); return `${d}/${m}/${y}`; }

async function carregar(){
  const ini = dtInicio.value;
  const fim = dtFim.value;

  let q = sb.from("buffet_lancamentos").select("*");
  if(ini) q = q.gte("data", ini);
  if(fim) q = q.lte("data", fim);

  const { data, error } = await q.order("data", { ascending:true });
  if(error){ console.error(error); return; }

  // Agrupar por empresa e dia
  const empresas = [...new Set(data.map(r=>r.empresa))];
  const dias = [...new Set(data.map(r=>r.data))];

  const porEmpresaDia = {};
  empresas.forEach(e=>{
    porEmpresaDia[e] = {};
    dias.forEach(d=> porEmpresaDia[e][d] = 0);
  });

  const kpis = {};
  const ranking = {};

  data.forEach(r=>{
    porEmpresaDia[r.empresa][r.data] += Number(r.quantidade||0);
    kpis[r.empresa] ||= {MONTAGEM:0,REPOSICAO:0,RETIRADA:0,DEVOLUCAO:0};
    kpis[r.empresa][r.tipo] += Number(r.quantidade||0);
    ranking[r.produto_nome] = (ranking[r.produto_nome]||0) + Number(r.quantidade||0);
  });

  // KPIs
  kpisEmpresas.innerHTML = empresas.map(e=>`
    <div class="kpi">
      <b>${e}</b><br>
      <small>Montagem: ${kpis[e]?.MONTAGEM?.toFixed(2)||0}</small><br>
      <small>Reposi√ß√£o: ${kpis[e]?.REPOSICAO?.toFixed(2)||0}</small><br>
      <small>Retirada: ${kpis[e]?.RETIRADA?.toFixed(2)||0}</small><br>
      <small>Devolu√ß√£o: ${kpis[e]?.DEVOLUCAO?.toFixed(2)||0}</small>
    </div>
  `).join("");

  // Chart Linhas
  if(chartLinhas) chartLinhas.destroy();
  chartLinhas = new Chart(chartLinhasEl, {
    type:'line',
    data:{
      labels: dias.map(formatBR),
      datasets: empresas.map((e,i)=>({
        label:e,
        data: dias.map(d=>porEmpresaDia[e][d]),
        tension:.35
      }))
    },
    options:{responsive:true, maintainAspectRatio:false}
  });

  // Chart Tipos (barras empilhadas)
  const tipos = ['MONTAGEM','REPOSICAO','RETIRADA','DEVOLUCAO'];
  if(chartTipos) chartTipos.destroy();
  chartTipos = new Chart(chartTiposEl, {
    type:'bar',
    data:{
      labels: empresas,
      datasets: tipos.map(t=>({
        label:t,
        data: empresas.map(e=>kpis[e]?.[t]||0)
      }))
    },
    options:{responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true}, y:{stacked:true}}}
  });

  // Ranking
  rankingDiv.innerHTML = Object.entries(ranking)
    .sort((a,b)=>b[1]-a[1]).slice(0,10)
    .map(([nome,val])=>`<div class="rank-item"><span>${nome}</span><b>${val.toFixed(2)}</b></div>`).join("");

  // Tabela
  tbody.innerHTML = data.map(r=>`
    <tr>
      <td>${formatBR(r.data)}</td>
      <td>${r.empresa}</td>
      <td>${r.produto_nome}</td>
      <td>${r.tipo}</td>
      <td>${r.quantidade} ${r.unidade}</td>
      <td>${r.hora}</td>
    </tr>
  `).join("");
}

const hoje = new Date();
dtFim.value = hoje.toISOString().slice(0,10);
dtInicio.value = new Date(hoje.getTime()-6*24*60*60*1000).toISOString().slice(0,10);
btnFiltrar.onclick = carregar;

const chartLinhasEl = document.getElementById("chartLinhas");
const chartTiposEl = document.getElementById("chartTipos");
const rankingDiv = document.getElementById("ranking");
const tbody = document.getElementById("tbody");
const kpisEmpresas = document.getElementById("kpisEmpresas");

carregar();
</script>
</body>
</html>
