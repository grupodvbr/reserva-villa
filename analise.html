<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Buffet ‚Ä¢ Anal√≠tico por Empresa</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f6f7fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#6b7280;
  --radius:16px;
  --shadow:0 10px 28px rgba(0,0,0,.10);
}
*{box-sizing:border-box;font-family:Inter}
html,body{margin:0;background:var(--bg)}
.app{max-width:100%;margin:auto;padding:8px 8px 64px}

.header{padding:8px 0 6px;margin-bottom:6px}
.title{font-size:18px;font-weight:900}
.sub{font-size:11px;color:var(--muted)}

.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px;margin-bottom:8px}

/* FILTROS RESPONSIVOS */
.filters{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px;
}
.filters input,
.filters button{
  width:100%;
  padding:9px 10px;border-radius:10px;border:1px solid var(--border);font-size:13px
}
.filters button{
  grid-column:1/-1;
  background:var(--primary);color:#fff;border:none;font-weight:800
}

/* Desktop */
@media(min-width: 900px){
  .app{max-width:1100px}
  .filters{grid-template-columns:1fr 1fr auto}
  .filters button{grid-column:auto}
}

.chart-wrap{height:140px}
.kpis{display:grid;grid-template-columns:1fr;gap:6px}
.kpi{border:1px solid var(--border);border-radius:12px;padding:8px;font-size:12px}
.kpi b{font-size:14px}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="title">üìä Desempenho por Empresa</div>
    <div class="sub">Produ√ß√£o vs Retiradas (por per√≠odo)</div>
  </div>

  <div class="card">
    <div class="filters">
      <input type="date" id="dtInicio">
      <input type="date" id="dtFim">
      <button id="btnFiltrar">Atualizar</button>
    </div>
  </div>

  <div class="card">
    <b style="font-size:13px">Produ√ß√£o total (Montagem + Reposi√ß√£o)</b>
    <div class="chart-wrap">
      <canvas id="chartProducao"></canvas>
    </div>
  </div>

  <div class="card">
    <b style="font-size:13px">Retiradas totais</b>
    <div class="chart-wrap">
      <canvas id="chartRetiradas"></canvas>
    </div>
  </div>

  <div class="card">
    <b style="font-size:13px">üèÜ Melhor desempenho no per√≠odo</b>
    <div id="melhor" class="kpis"></div>
  </div>

</div>

<script>
const sb = window.supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const dtInicio = document.getElementById("dtInicio");
const dtFim = document.getElementById("dtFim");
const btnFiltrar = document.getElementById("btnFiltrar");

let chartProducao, chartRetiradas;

async function carregar(){
  let q = sb.from("buffet_lancamentos").select("*");
  if(dtInicio.value) q = q.gte("data", dtInicio.value);
  if(dtFim.value) q = q.lte("data", dtFim.value);

  const { data } = await q;

  const empresas = {};
  data?.forEach(r=>{
    empresas[r.empresa] ||= {prod:0, retir:0};
    if(r.tipo==='MONTAGEM' || r.tipo==='REPOSICAO'){
      empresas[r.empresa].prod += Number(r.quantidade||0);
    }
    if(r.tipo==='RETIRADA'){
      empresas[r.empresa].retir += Number(r.quantidade||0);
    }
  });

  const labels = Object.keys(empresas);
  const prodVals = labels.map(e=>empresas[e].prod);
  const retVals = labels.map(e=>empresas[e].retir);

  if(chartProducao) chartProducao.destroy();
  chartProducao = new Chart(document.getElementById("chartProducao"), {
    type:'bar',
    data:{ labels, datasets:[{ data:prodVals }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });

  if(chartRetiradas) chartRetiradas.destroy();
  chartRetiradas = new Chart(document.getElementById("chartRetiradas"), {
    type:'bar',
    data:{ labels, datasets:[{ data:retVals }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });

  let melhorEmpresa = null, melhorScore = -Infinity;
  Object.entries(empresas).forEach(([e,v])=>{
    const score = v.prod - v.retir;
    if(score > melhorScore){ melhorScore = score; melhorEmpresa = e; }
  });

  melhor.innerHTML = melhorEmpresa ? `
    <div class="kpi">
      <b>${melhorEmpresa}</b><br>
      Produ√ß√£o: ${empresas[melhorEmpresa].prod.toFixed(2)}<br>
      Retiradas: ${empresas[melhorEmpresa].retir.toFixed(2)}<br>
      <small>Score: ${melhorScore.toFixed(2)}</small>
    </div>
  ` : '<small>Sem dados no per√≠odo.</small>';
}

const hoje = new Date();
dtFim.value = hoje.toISOString().slice(0,10);
dtInicio.value = new Date(hoje.getTime()-6*24*60*60*1000).toISOString().slice(0,10);

btnFiltrar.onclick = carregar;
carregar();
</script>
</body>
</html>
