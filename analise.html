<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Buffet ‚Ä¢ Anal√≠tico</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#6b7280;
  --radius:18px;
  --shadow:0 14px 36px rgba(0,0,0,.12);
}
*{box-sizing:border-box;font-family:Inter}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#fff, var(--bg))}
.app{max-width:1200px;margin:0 auto;padding:12px;min-height:100dvh;display:flex;flex-direction:column}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.title{font-size:22px;font-weight:900}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;margin-bottom:10px}
.filters{display:grid;grid-template-columns:1fr 1fr auto;gap:8px}
input,button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:15px}
button.primary{background:var(--primary);color:#fff;border:none;font-weight:800}

.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.kpi{border:1px solid var(--border);border-radius:14px;padding:10px}
.kpi b{font-size:16px}
.kpi small{color:var(--muted)}

.charts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.chart-card{height:260px}

@media (max-width: 900px){
  .filters{grid-template-columns:1fr}
  .charts{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr}
  .chart-card{height:220px}
}
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <div class="title">üìä Buffet ‚Ä¢ Anal√≠tico</div>
    <a href="./index.html" style="text-decoration:none">‚¨ÖÔ∏è Voltar</a>
  </div>

  <div class="card">
    <div class="filters">
      <input type="date" id="dtInicio">
      <input type="date" id="dtFim">
      <button class="primary" id="btnFiltrar"><i class="ri-filter-3-line"></i> Atualizar</button>
    </div>
  </div>

  <div class="card">
    <b>Resumo por empresa (per√≠odo)</b>
    <div id="kpisEmpresas" class="kpis"></div>
  </div>

  <div class="charts">
    <div class="card chart-card">
      <b>Evolu√ß√£o di√°ria</b>
      <canvas id="chartLinhas"></canvas>
    </div>
    <div class="card chart-card">
      <b>Distribui√ß√£o por tipo</b>
      <canvas id="chartTipos"></canvas>
    </div>
  </div>
</div>

<script>
const sb = window.supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const dtInicio = document.getElementById("dtInicio");
const dtFim = document.getElementById("dtFim");
const btnFiltrar = document.getElementById("btnFiltrar");
let chartLinhas, chartTipos;

function formatBR(iso){ const [y,m,d]=iso.split("-"); return `${d}/${m}/${y}`; }

async function carregar(){
  const ini = dtInicio.value;
  const fim = dtFim.value;

  let q = sb.from("buffet_lancamentos").select("*");
  if(ini) q = q.gte("data", ini);
  if(fim) q = q.lte("data", fim);

  const { data, error } = await q.order("data", { ascending:true });
  if(error){ console.error(error); return; }

  const empresas = [...new Set(data.map(r=>r.empresa))];
  const dias = [...new Set(data.map(r=>r.data))];

  const porEmpresaDia = {};
  const kpis = {};

  empresas.forEach(e=>{
    porEmpresaDia[e] = {};
    dias.forEach(d=> porEmpresaDia[e][d] = 0);
    kpis[e] = {MONTAGEM:0, REPOSICAO:0, RETIRADA:0, DEVOLUCAO:0};
  });

  data.forEach(r=>{
    porEmpresaDia[r.empresa][r.data] += Number(r.quantidade||0);
    kpis[r.empresa][r.tipo] += Number(r.quantidade||0);
  });

  // KPIs
  kpisEmpresas.innerHTML = empresas.map(e=>`
    <div class="kpi">
      <b>${e}</b><br>
      <small>M: ${kpis[e].MONTAGEM.toFixed(1)} | R: ${kpis[e].REPOSICAO.toFixed(1)}</small><br>
      <small>Ret: ${kpis[e].RETIRADA.toFixed(1)} | Dev: ${kpis[e].DEVOLUCAO.toFixed(1)}</small>
    </div>
  `).join("");

  // Chart Linhas
  if(chartLinhas) chartLinhas.destroy();
  chartLinhas = new Chart(document.getElementById("chartLinhas"), {
    type:'line',
    data:{
      labels: dias.map(formatBR),
      datasets: empresas.map((e)=>({
        label:e,
        data: dias.map(d=>porEmpresaDia[e][d]),
        tension:.35,
        fill:false
      }))
    },
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}}
  });

  // Chart Tipos
  const tipos = ['MONTAGEM','REPOSICAO','RETIRADA','DEVOLUCAO'];
  if(chartTipos) chartTipos.destroy();
  chartTipos = new Chart(document.getElementById("chartTipos"), {
    type:'bar',
    data:{
      labels: empresas,
      datasets: tipos.map(t=>({
        label:t,
        data: empresas.map(e=>kpis[e][t])
      }))
    },
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}}
  });
}

const hoje = new Date();
dtFim.value = hoje.toISOString().slice(0,10);
dtInicio.value = new Date(hoje.getTime()-6*24*60*60*1000).toISOString().slice(0,10);
btnFiltrar.onclick = carregar;

carregar();
</script>
</body>
</html>
