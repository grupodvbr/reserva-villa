<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Buffet ‚Ä¢ Anal√≠tico Operacional</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --primary:#ff6a00; --bg:#f4f6fb; --card:#fff; --border:#e5e7eb;
  --muted:#6b7280; --radius:18px; --shadow:0 14px 36px rgba(0,0,0,.12);
}
*{box-sizing:border-box;font-family:Inter}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#fff, var(--bg))}
.app{max-width:1200px;margin:0 auto;padding:12px;min-height:100dvh;display:flex;flex-direction:column}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.title{font-size:22px;font-weight:900}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;margin-bottom:10px}
.filters{display:grid;grid-template-columns:1fr 1fr auto;gap:8px}
input,select,button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:15px}
button.primary{background:var(--primary);color:#fff;border:none;font-weight:800}

.chart-card{height:220px}
.table{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
th{background:#fafafa;position:sticky;top:0}

.cards{display:none;gap:8px}
.card-item{border:1px solid var(--border);border-radius:14px;padding:10px}

@media (max-width: 900px){
  .filters{grid-template-columns:1fr}
  .chart-card{height:200px}
  .table{display:none}
  .cards{display:grid}
}
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <div class="title">üìä Buffet ‚Ä¢ Anal√≠tico Operacional</div>
    <a href="./index.html" style="text-decoration:none">‚¨ÖÔ∏è Voltar</a>
  </div>

  <div class="card">
    <div class="filters">
      <input type="date" id="dtInicio">
      <input type="date" id="dtFim">
      <button class="primary" id="btnFiltrar"><i class="ri-filter-3-line"></i> Atualizar</button>
    </div>
  </div>

  <div class="card chart-card">
    <b>Total produzido por dia (Montado + Reposto)</b>
    <canvas id="chartTotal"></canvas>
  </div>

  <div class="card table">
    <b>Resumo por prato (per√≠odo)</b>
    <table>
      <thead>
        <tr>
          <th>Prato</th>
          <th>Montado</th>
          <th>Reposto</th>
          <th>Total Produzido</th>
          <th>Retirado</th>
          <th>Devolvido</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="cards" id="cards"></div>
</div>

<script>
const sb = window.supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const dtInicio = document.getElementById("dtInicio");
const dtFim = document.getElementById("dtFim");
const btnFiltrar = document.getElementById("btnFiltrar");

let chartTotal;

function formatBR(iso){ const [y,m,d]=iso.split("-"); return `${d}/${m}/${y}`; }

async function carregar(){
  const ini = dtInicio.value;
  const fim = dtFim.value;

  let q = sb.from("buffet_lancamentos").select("*");
  if(ini) q = q.gte("data", ini);
  if(fim) q = q.lte("data", fim);

  const { data, error } = await q.order("data", { ascending:true });
  if(error){ console.error(error); return; }

  // Agrega√ß√£o por prato
  const porPrato = {};
  const porDia = {};

  data.forEach(r=>{
    porPrato[r.produto_nome] ||= {MONTAGEM:0, REPOSICAO:0, RETIRADA:0, DEVOLUCAO:0};
    porPrato[r.produto_nome][r.tipo] += Number(r.quantidade||0);

    if(r.tipo === 'MONTAGEM' || r.tipo === 'REPOSICAO'){
      porDia[r.data] = (porDia[r.data]||0) + Number(r.quantidade||0);
    }
  });

  // Tabela / Cards
  const linhas = Object.entries(porPrato).map(([nome, v])=>{
    const totalProd = v.MONTAGEM + v.REPOSICAO;
    return `
      <tr>
        <td><b>${nome}</b></td>
        <td>${v.MONTAGEM.toFixed(2)}</td>
        <td>${v.REPOSICAO.toFixed(2)}</td>
        <td><b>${totalProd.toFixed(2)}</b></td>
        <td>${v.RETIRADA.toFixed(2)}</td>
        <td>${v.DEVOLUCAO.toFixed(2)}</td>
      </tr>
    `;
  }).join("");

  tbody.innerHTML = linhas || `<tr><td colspan="6">Sem dados</td></tr>`;

  cards.innerHTML = Object.entries(porPrato).map(([nome, v])=>{
    const totalProd = v.MONTAGEM + v.REPOSICAO;
    return `
      <div class="card-item">
        <b>${nome}</b><br>
        Montado: ${v.MONTAGEM.toFixed(2)}<br>
        Reposto: ${v.REPOSICAO.toFixed(2)}<br>
        <b>Total: ${totalProd.toFixed(2)}</b><br>
        Retirado: ${v.RETIRADA.toFixed(2)}<br>
        Devolvido: ${v.DEVOLUCAO.toFixed(2)}
      </div>
    `;
  }).join("");

  // Gr√°fico (Total produzido por dia)
  const dias = Object.keys(porDia).sort();
  const valores = dias.map(d=>porDia[d]);

  if(chartTotal) chartTotal.destroy();
  chartTotal = new Chart(document.getElementById("chartTotal"), {
    type:'line',
    data:{ labels:dias.map(formatBR), datasets:[{ label:'Total produzido', data: valores, tension:.35 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });
}

const hoje = new Date();
dtFim.value = hoje.toISOString().slice(0,10);
dtInicio.value = new Date(hoje.getTime()-6*24*60*60*1000).toISOString().slice(0,10);
btnFiltrar.onclick = carregar;

carregar();
</script>
</body>
</html>
