<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Buffet ‚Ä¢ An√°lises & Relat√≥rios</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --primary:#ff6a00; --bg:#f4f6fb; --card:#fff; --border:#e5e7eb;
  --muted:#6b7280; --radius:18px; --shadow:0 16px 40px rgba(0,0,0,.12);
}
*{box-sizing:border-box;font-family:Inter}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#fff, var(--bg))}
.app{max-width:1400px;margin:0 auto;padding:14px;min-height:100dvh;display:flex;flex-direction:column}
.header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:22px;font-weight:900}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
.filters{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr;gap:10px}
input,select,button{padding:12px 14px;border-radius:12px;border:1px solid var(--border);font-size:16px}
button.primary{background:var(--primary);color:#fff;border:none;font-weight:800}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{border:1px solid var(--border);border-radius:14px;padding:12px}
.kpi b{font-size:18px}
@media (max-width: 900px){
  .filters{grid-template-columns:1fr}
  .grid{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr 1fr}
}
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <div class="title">üìä Buffet ‚Ä¢ An√°lises (Todos os Dias)</div>
    <a href="./index.html" style="text-decoration:none">‚¨ÖÔ∏è Voltar ao Operacional</a>
  </div>

  <div class="card">
    <div class="filters">
      <select id="empresaSelect">
        <option value="VILLA GOURMET">Villa Gourmet</option>
        <option value="CHURRASCADA">Churrascada</option>
        <option value="MERCATTO DEL√çCIA">Mercatto Del√≠cia</option>
      </select>
      <input type="date" id="dtInicio">
      <input type="date" id="dtFim">
      <button class="primary" id="btnFiltrar"><i class="ri-filter-3-line"></i> Filtrar</button>
    </div>
  </div>

  <div class="card kpis">
    <div class="kpi"><small>Montagem (Total)</small><b id="kpiMontagem">0</b></div>
    <div class="kpi"><small>Reposi√ß√£o (Total)</small><b id="kpiReposicao">0</b></div>
    <div class="kpi"><small>Retirada (Total)</small><b id="kpiRetirada">0</b></div>
    <div class="kpi"><small>Devolu√ß√£o (Total)</small><b id="kpiDevolucao">0</b></div>
  </div>

  <div class="grid">
    <div class="card">
      <b>üìà Evolu√ß√£o por Dia (Total de Quantidade)</b>
      <canvas id="chartLinha" height="120"></canvas>
    </div>
    <div class="card">
      <b>üìä Distribui√ß√£o por Tipo (Per√≠odo)</b>
      <canvas id="chartBarras" height="120"></canvas>
    </div>
  </div>

  <div class="card">
    <b>üßæ Registros do Per√≠odo</b>
    <div id="tabela"></div>
  </div>
</div>

<script>
const sb = window.supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const empresaSelect = document.getElementById("empresaSelect");
const dtInicio = document.getElementById("dtInicio");
const dtFim = document.getElementById("dtFim");
const btnFiltrar = document.getElementById("btnFiltrar");

let chartLinha, chartBarras;

function formatBR(iso){
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}

async function carregarAnalitico(){
  const empresa = empresaSelect.value;
  const ini = dtInicio.value;
  const fim = dtFim.value;

  let query = sb.from("buffet_lancamentos").select("*").eq("empresa", empresa);
  if(ini) query = query.gte("data", ini);
  if(fim) query = query.lte("data", fim);

  const { data, error } = await query.order("data", { ascending:true });
  if(error){ console.error(error); return; }

  // KPIs
  let tot = { MONTAGEM:0, REPOSICAO:0, RETIRADA:0, DEVOLUCAO:0 };
  const porDia = {};

  data.forEach(r=>{
    tot[r.tipo] += Number(r.quantidade || 0);
    porDia[r.data] = (porDia[r.data] || 0) + Number(r.quantidade || 0);
  });

  kpiMontagem.textContent = tot.MONTAGEM.toFixed(2);
  kpiReposicao.textContent = tot.REPOSICAO.toFixed(2);
  kpiRetirada.textContent = tot.RETIRADA.toFixed(2);
  kpiDevolucao.textContent = tot.DEVOLUCAO.toFixed(2);

  // Gr√°fico Linha
  const labels = Object.keys(porDia).map(formatBR);
  const valores = Object.values(porDia);

  if(chartLinha) chartLinha.destroy();
  chartLinha = new Chart(document.getElementById("chartLinha"), {
    type: 'line',
    data: { labels, datasets: [{ label:'Total por dia', data: valores, tension:.35 }] },
    options: { responsive:true, maintainAspectRatio:false }
  });

  // Gr√°fico Barras
  if(chartBarras) chartBarras.destroy();
  chartBarras = new Chart(document.getElementById("chartBarras"), {
    type: 'bar',
    data: {
      labels: ['Montagem','Reposi√ß√£o','Retirada','Devolu√ß√£o'],
      datasets: [{ label:'Total no per√≠odo', data:[
        tot.MONTAGEM, tot.REPOSICAO, tot.RETIRADA, tot.DEVOLUCAO
      ]}]
    },
    options: { responsive:true, maintainAspectRatio:false }
  });

  // Tabela simples
  const rows = data.map(r=>`
    <tr>
      <td>${formatBR(r.data)}</td>
      <td>${r.produto_nome}</td>
      <td>${r.tipo}</td>
      <td>${r.quantidade} ${r.unidade}</td>
      <td>${r.hora}</td>
    </tr>
  `).join("");

  tabela.innerHTML = `
    <div style="overflow:auto">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Hora</th>
          </tr>
        </thead>
        <tbody>${rows || '<tr><td colspan="5">Sem dados</td></tr>'}</tbody>
      </table>
    </div>
  `;
}

btnFiltrar.onclick = carregarAnalitico;

// datas padr√£o (√∫ltimos 7 dias)
const hoje = new Date();
const fim = hoje.toISOString().slice(0,10);
const ini = new Date(hoje.getTime() - 6*24*60*60*1000).toISOString().slice(0,10);
dtInicio.value = ini;
dtFim.value = fim;

carregarAnalitico();
</script>
</body>
</html>
